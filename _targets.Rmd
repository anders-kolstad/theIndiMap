---
title: "IndiMap plots and analyses"
output: html_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>")
```

This report will

- compile indicator profiles `"/data/indicatorProfiles/"` and publication profiles `"/data/pulicationProfiles/"` into long format
- Perform resampling to craete dummy data
- Create plots and summary statistics


<!-- Target Markdown is a powerful R Markdown interface for reproducible analysis pipelines, and the chapter at https://books.ropensci.org/targets/markdown.html walks through it in detail. This R Markdown report the example from the chapter. Try it out in both interactive and non-interactive modes, either by running the code chunks in different ways or setting the `tar_interactive` chunk option. -->

# Packages

Here are the required packages
```{r, eval = FALSE}
install.packages(c("tidyverse"))
```
```{r, echo=T, warning=F, message=F}
library(targets)
library(tidyverse)
```


```{targets setup-targets}
tar_option_set(packages = c("tidyverse", "dplyr", "purrr", "readr", "tidyr"))
options(tidyverse.quiet = TRUE)
```

# Setup


```{r, echo=F}
#Remove R scripts from previous non-interactive runs
tar_unscript()
```


# Globals

We first define some global options/functions common to all targets. The function below plots a histogram of ozone concentrations, and our histogram target will need it.

```{targets example-globals, tar_globals = TRUE}
#| tar_interactive: FALSE

create_hist <- function(data) {
  ggplot(data) +
    geom_histogram(aes(x = Ozone), bins = 12) +
    theme_gray(24)
}
```

# Targets

Our first target reads in all the file names in `data/publicationProfiles` and stores them in a single object, which we can then monitor for updates.

```{targets pp-ls}
#| tar_interactive: FALSE
tar_target(ppls, 
           list.files("data/publicationProfiles", full.names = T), 
           cue = tar_cue(mode = "thorough"), 
           format="file")
```

Then we import these files

```{targets pp-import}
#| tar_interactive: FALSE
tar_target(import_profiles, purrr::map_df(ppls, 
                                     function(x)
                                       read.csv(x,
                                                header=T) %>%
                                       pivot_wider(names_from = parameter, values_from = value)
                                   ),
           packages = c("tidyverse", "dplyr", "purrr", "readr", "tidyr"))

```


<!-- Set the `tar_simple` chunk option to `TRUE` to define a single target with the command in the code chunk. The chunk below only contains `biglm(Ozone ~ Wind + Temp, data)` in the source, but because `tar_simple` is `TRUE`, it is shorthand for `tar_target(name = fit, command = biglm(Ozone ~ Wind + Temp, data))`. All other arguments to `tar_target()` are set to their default values (configurable with `tar_option_set()`). -->

<!-- ```{targets fit, tar_simple = TRUE} -->
<!-- biglm(Ozone ~ Wind + Temp, data) -->
<!-- ``` -->

# Pipeline

If you ran all the `{targets}` chunks in non-interactive mode, then your R scripts are set up to run the pipeline.

```{r}
tar_make()
```

# Output

<!-- You can retrieve results from the `_targets/` data store using `tar_read()` or `tar_load()`. -->

The `targets` dependency graph helps your readers understand the steps of your pipeline at a high level.

```{r}
tar_visnetwork()
```


